## chapter 7 java虚拟机

### 7.4 Java 本地接口 JNI
 * 作用
   + 提供一个标准方式让Java虚拟机与原生代码进行交互。
 * 动机
   + 提高性能。由于慢于底层操作系统上原生的C和C++等语言
   + 特殊需求。与底层硬件平台直接交互的功能
   
 * 使用
   + 原生方法对应C/C++方法是
       - Java_com_bmn_rt_lang_BmnNative_sqrt
       - Java_开头+包名+类名+方法名
   + C/C++方法中最前面两个标准参数
       - 第一个参数是JNIEnv接口指针，可台访问和操作虚拟机中数据结构。
       - 第二个参数是如果实例方法是this, 静态方法是class
       
 * java 程序中集成C/C++代码
   + JNA
       - 优点，开发人员不需要直接使用C/C++
       - 缺点，性能、不能使用宏、不能使用头文件定义的常量
       
 * C/C++中启动java虚拟机
 
### 7.5 HotSpot虚拟机
 * 执行字节码时一般采用即时编译方式，JIT()
 * 对JIT优化，即热点, 所以叫HotSpot
 
#### 垃圾回收
 * 采用分代回收方式
 * 不同代采用不同回收算法
 * 如何选择垃圾算法
   1. 使用串行还是并行
   2. 对回收过程中发现的存活对象的处理方式
      - 压缩，分配速度快，但需要时间移动对象
      - 不压缩，回收快，但内在分配速度慢
      - 复制
   - 都是在垃圾回收操作花费时间与后续内存分配操作花费时间进行权衡。
   
  * HotSpot会根据硬件平台能力选择最适合的垃圾回收方式。
    + 硬件平台根据性能分：服务器级别与非服务器级别
    + 服务器级别：2个以上CPU,2G以上物理内存
      - 采用并行回收
      - 初始堆 1/64
      - 最大堆 1/4
    + 非服务器级别：
      - 默认采用串行回收
      - 初始堆 4M
      - 最大堆 64M  
  * 启动参数优化-垃圾回收目标
    + 降低回收时造成程序停顿时间
      - XX:MaxGCPauseMillis
    + 提高吞吐量
      - 指垃圾回收操作与程序实际运行时间比例。
      - 应尽可能多的时间花费在程序运行上，同时保证垃圾回收操作不受影响
      - XX:GCTimeRadio, 指定垃圾回收占比
      - XX:GCTimeRadio=49 即 1/(1+49)= 2%
    + 降低程序内存占用量
    
  * 可选垃圾回收算法
    + -XX:+UseSerialGC， 串行回收
      - 非服务器级别硬件平台默认回收方式
    + -XX:+UseParallelGC 并行回收
      - 服务器级别硬件平台默认回收方式
      - 对年轻代使用并行回收，减少回收时间，提高吞吐量
      - 对老年代采用串行回收方式
    + -XX:+UseParallelOldGC 并行老年代回收
      - 并发标记
      - 标记完成后，进行压缩
    + -XX:+UseConcMarkSweepGC 并发标记清除
      - 停顿时间短
      - 程序暂停，初始标记阶段
      - 程序执行，程序继续运行同时垃圾回收器从上一阶段标记出的存活对象，递归标记可达其它存活对象。这个阶段与程序并发执行
      - 程序暂停，对变化的对象重新标记。
      - 程序执行，并发回收垃圾
      - 不会进行内存压缩
    + -XX:+UseG1GC grabage first 垃圾优先, java7新加的
      - 并行回收
      
#### 7.5.3 启动参数
  * 标准参数
    + 每个虚拟机都实现的
  * 非标准参数：
    + 不是每个虚拟机都有的。可能会以后删除
    + -X 开头
    + 
  * -XX 开头实现不是很稳定。一般不推荐使用
    + 布尔型参数，通过 -XX:+<option> 形式打开。-XX:-<option> 形式关闭
    + 数值型参数，通过 -XX:<option>=<number>
    + 字符串类型，通过 -XX:<option>=<string>
    
#### 虚拟机资源
  * 缓冲区
  * 类加载系统
  * 代码编码
  * 垃圾回收器
  * 内存
  * 底层操作系统
  * 虚拟机运行时
  * 线程
  * 日志记录器
  * 等
    
#### 7.5.5 java虚拟机工具接口 JVM TI
  * 只能使用原生代码实现
  * 只用于创建java程序的各种工具
  * 头文件jvmti.h
  * 通过-agenlib或-agentpath加入到虚拟机中