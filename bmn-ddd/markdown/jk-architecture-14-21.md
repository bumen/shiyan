### 第14章 高性能数据库集群：读写分离
 * 单个数据库服务器已经难以满足业务需要，必须考虑数据库集群的方式来提升性能。
 
### 读写分离原理 
 * 读写分离的基本原理是将数据库读写操作分散到不同的节点上
 * 基本实现
   + 数据库服务器搭建主从集群，一主一从，一主多从都可以
   + 数据库主机负责读写操作，从机只负责读操作
   + 数据库主机通过复制将数据同步到从机，每台数据库服务器都存储了所有的业务数据
   + 业务服务器将写操作发给数据库主机，将读操作发给数据库从机 
 * 设计复杂度
   + 主从复制延迟
   + 分配机制
   
 * 复制延迟-解决方法
   1. 写操作后的读操作指定发给数据库主服务器
     + 这种方式和业务强绑定，对业务侵入和影响较大
   2. 读从机失败后再读一次主机
     + 这就是常说的二次读，和业务无绑定。
     + 缺点：将大大增加主机的读操作压力。如果出现扫库可能主库会崩溃
   3. 关键业务读写操作全部指向主机，非关键业务采用读写分离
     
 * 分配机制-解决方法
   1. 程序代码封装
     + 在程序代码中抽象一个数据访问层，实现读写操作分离和数据库服务器连接的管理
     + 实现简单，根据业务做软多的定制化
     + 不同语言，无法通用。
     + 故障情况下，如果主从发生切换，则可能需要所有系统都修改配置并重启
     + 开源方案：淘宝TDDL，具有主备，读写分离，动态数据库配置等功能
   2. 中间件封装 
     + 独立一套系统出来，实现读写操作分离和数据库服务连接的管理
     + 特点
        - 支持多种语言
        - 需要支持完整sql语法和数据库服务器的协议，实现比较复杂
        - 主从切换没感知
     + 开源
        - mysql提供的mysql proxy
        - mysql提供的mysql router。读写分离，自动故障切换，负载均衡，连接池    
        - 360的atlas
        
### 第15章 高性能数据库集群：分库分表
 * 当数据量达到千万甚至上亿条的时候，单台数据库服务器的存储能力会成为系统的瓶颈
   + 数据量太大，读写的性能会下降，即使有索引，索引也会变得很大，性能同样会下降。
   + 数据文件会变得很大，数据库备份和恢复需要耗费很长时间。
   + 数据文件越大，极端情况下丢失数据的风险越高
 
 * 业务分库-带来的问题
   1. join操作问题
   2. 事务问题
   3. 成本问题
   
 * 分表-垂直分表-带来的问题
   + 一条记录，切分为不同表存。查询时需要查询多次
 * 分表-水平分表
   + 路由
      - 范围路由：可能分布不均匀
      - hash路由：均匀但新加表需要重新hash
      - 配置路由：创建一个配置表，记录所在映射关系。缺点配置表太大怎么办
   + join操作
   + count操作
   + order by操作
   
### 第16章 高性能NoSQL
 * 关系数据库缺点
   1. 关系数据库存储的是行记录，无法存储数据结构
   2. 关系数据库的schema扩展很不方便
   3. 关系数据库在大数据场景下I/O较高
   4. 关系数据库的全文搜索功能比较弱
   
 * 针对上述问题，分别产生了不同的NoSQL解决方案。NoSQL同时也牺牲了ACID某个或某几个特性，因此我们应该将NoSQL作为sql
 的一个有力补充，NoSQL != No SQL, 而是NoSQL = Not Only SQL
 
 * 常见NoSQL方案分4类
   1. k-v存储：解决关系数据库无法存储数据结构的问题，以redis为代表。
   2. 文档数据库：解决关系数据库强schema约束的问题，以MongoDB为代表。
   3. 列式数据库：解决关系数据库大数据场景下的I/O问题，以HBase为代表。
   4. 全文搜索引擎：解决关系数据库的全文搜索性能问题，以Elasticsearch为代表。
   
 * K-V存储
   + 也被称为数据结构服务器
   
 * 文档数据库
   + 最大特点：no-schema，可以存储和读取任意的数据。目前绝大部分文档数据库存储数据的格式为JSON或BSON
   + 适合游戏和电商
      - 如：都是商品，但属性有很大区别
   + 优点
      - 新增字段简单
      - 历史数据不会出错
      - 可以容易存储复杂数据
   + 缺点
      - 不支持事物
      - 无法实现关系数据库的join操作
      
 * 列式数据库
   + 行式存储的优点
      - 业务同时读取多个列时效率高，因为这些列都是按行存储在一起的，一 次磁盘操作就能够把一行数据诹到内存
      - 能够一次性完成对一行中多个列的写操作，保证了写操作的原子和一致性
      
   + 列式优点
      - 大数据记录列需要较小I/O
      
   + 列式缺点
      - 更新多个列时，因为列存储在磁盘上不连接的空间，导致更新多个列是随机写操作
      
 * 全文搜索
   + 原理是使用倒排序。通过建立关键字到文档的索引
   
   
### 高性能缓存架构 
 * 解决问题
   + 需要经过复杂运算后得出的数据，存储系统无能为力
   + 读多写少的数据，存储系统有心无力
   + 缓存就是为了弥补存储系统在这些复杂业务场景下的不足，其基本原理是将可能重复使用的数据放到内存中，一次生成、多次使用，避免每次使用都去访问存储系统
   
 * 缓存穿透
   1. 存储数据不存在
   2. 缓存数据生成耗费大量时间或者资源
 * 缓存雪崩
   + 同进大量缓存失效
   + 缓存雪崩的常见解决方法有两种：更新锁机制和后台更新机制。
 * 缓存热点
   + 缓存热点的解决方案就是复制多份缓存副本，将请求分散到多个缓存服务器上，减轻缓存热点导致的单台缓存服务器压力。
   
### 单台服务器高性能模式：PPC与TPC
 * 高性能架构设计主要集中在两方面：
   + 尽量提升单服务器的性能，将单服务器的性能发挥到极致。
   + 如果单服务器无法支撑性能，设计服务器集群方案。
   
 * 单服务器高性能的关键之一服务器采取的并发模型。并发模型设计关键两点：
   + 服务器如何管理连接。
   + 服务器如何处理请求。
   + 以上两个设计点最终都和操作系统的 I/O 模型及进程模型相关
     - I/O 模型：阻塞、非阻塞、同步、异步。
     - 进程模型：单进程、多进程、多线程。
     
 * PPC（Process Per Connection）
   + 其含义是指每次有新的连接就新建一个进程去专门处理这个连接的请求，这是传统的 UNIX 网络服务器所采用的模型
   + 基本的流程
     - 父进程接受连接
     - 父进程“fork”子进程
     - 子进程处理连接的读写请求
     - 子进程关闭连接
   + 缺点
     - fork 代价高
     - 父子进程通信复杂
     - 支持的并发连接数量有限
        - 一般情况下，PPC 方案能处理的并发连接数量最大也就几百。
        
   + prefork方式
     - 系统在启动的时候就预先创建好进程，然后才开始接受用户的请求，当有新的连接进来的时候，就可以省去 fork 进程的操作，让用户访问更快、体验更好。
     - 优点
       1. 每个进程单独处理连接
     - 与PPC类似有父子进程通信问题，并发连接数量有限
     
     
 * TPC（Thread Per Connection）
   + 其含义是指每次有新的连接就新建一个线程去专门处理这个连接的请求
   
   + prethread
   
### 单服务器高性能模式：Reactor与Proactor
 * Reactor
   + 就是I/O 多路复用结合线程池
   + Reactor 模式的核心组成部分包括 Reactor 和处理资源池（进程池或线程池）
     - Reactor 负责监听和分配事件
     - 处理资源池负责处理事件
   + I/O多路复用
     - 当多条连接共用一个阻塞对象后，进程只需要在一个阻塞对象上等待，而无须再轮询所有连接
     
   + Reactor 是非阻塞同步网络模型，因为真正的 read 和 send 操作都需要用户进程同步操作。
   这里的“同步”指用户进程在执行 read 和 send 这类 I/O 操作的时候是同步的，
   如果把 I/O 操作改为异步就能够进一步提升性能，这就是异步网络模型 Proactor。
   
 * Proactor
 
 
### 高性能负载均衡：分类及架构
 * DNS 负载均衡
   + 优点
     - 简单、成本低
     - 就近访问，提升访问速度
   + 缺点
     - 更新不及时：DNS 缓存的时间比较长，修改 DNS 配置后
     - 扩展性差：DNS 负载均衡的控制权在域名商那里
     - 分配策略比较简单：DNS 负载均衡支持的算法少
 * 硬件负载均衡
   + F5和A10
   + 优点
     - 功能强大：全面支持各层级的负载均衡，支持全面的负载均衡算法，支持全局负载均衡。
     - 性能强大：百万并发
     - 稳定性高
     - 支持安全防护：硬件均衡设备除具备负载均衡功能外，还具备防火墙、防 DDoS 攻击等安全功能。
   + 缺点
     - 价格昂贵
     - 扩展能力差
     
 * 软件负载均衡
   + nginx 7层协议, LVS 4层协议
   + nginx：5万/s, LVS: 十几万/s
   + 优点
     - 简单：无论是部署还是维护都比较简单。
     - 便宜
     - 灵活
     
   + 缺点
     - 性能一般
     - 功能没有硬件负载均衡那么强大
     - 一般不具备防火墙和防 DDoS 攻击等安全功能
     
 * 负载均衡典型架构
   + 组合的基本原则为：
     - DNS 负载均衡用于实现地理级别的负载均衡；
     - 硬件负载均衡用于实现集群级别的负载均衡；
     - 软件负载均衡用于实现机器级别的负载均衡。
     
 * TPS：代表写请求， QPS：代表读请求
 
### 高性能负载均衡：算法 
 * 
   
     
        
    