

### 第4章 复杂度来源-高性能
 * 软件系统中高性能带来的复杂度主要体现在两方面
   1. 单台计算机内部为了高性能带来的复杂度
   2. 多台计算机集群为了高性能带来的复杂度
   
 * 单机复杂度
   + 操作系统的复杂度直接决定了软件系统的复杂度。
   + 操作系统和性能最相关的就是进程和线程
     - 进程间通信：包括管道、消息队列、信号量、共享存储等
     - 多线程发展：导致操作系统调度的最小单元变成了线程，而进程变成了操作系统分配资源的最小单位
     - 发展到现在，如果我们要完成一个高性能的软件系统，需要考虑如多进程，多线程，进程间通信，多线程并发等技术点
     
     
 * 集群复杂度
   + 解决方案
     1. 任务分配
     2. 任务分解
     
   + 任务分配
     - 将请求分发给不同机器，每个机器都能独立完整对应业务
     - 角色
       1. 任务分配器
       2. 任务服务器
     - 一台任务分配器，可以是硬件网络设备（F5，交换机等），软件网络设备（LVS），负载均衡软件（nginx haproxy），还可以
     是自己开发的软件。选择合适的分配器是一件复杂的事情，考虑性能，成本，可维护性，可用性等
     - 一台任务分配器和真正任务服务器之间有连接和交互。要选择合适的连接方式，并对连接进行管理。如连接创建，检测，中断后处理
     - 一台任务分配器，需要增加分配算法。轮询，权重，按负载
     - 多台任务分配器，这个变化带来的复杂度需要将不同的用户分配到不同的任务分配器上。如DNS轮询，智能DNS，CDN，GSLB等
     - 多台任务分配器与业务服务器连接从简单1对多，变成多对多的网关状结构，状态管理，故障处理复杂度也大大增加

   
   + 任务分解
     - 主要原因是业务越来越复杂，单台机器处理的性能会越来越低。为了能够继续提升性能，我们需要采取第二种方式：任务分解。
     - 通过这种任务分解的方式，能够把原来大一统但复杂的业务系统，拆分成小而简单但需要多个系统配合的业务系统
     - 如何通过任务分解就能够提升性能？
       1. 简单的系统更加容易做到高性能
       2. 可以针对单个任务进行扩展
       
     - 虽然系统拆分可能在某种程度上能提升业务处理性能，但提升性能也是有限的，
     不可能系统不拆分的时候业务处理耗时为 50ms，系统拆分后业务处理耗时只要 1ms，
     因为最终决定业务处理性能的还是业务逻辑本身，业务逻辑本身没有发生大的变化下，
     理论上的性能是有一个上限的，系统拆分能够让性能逼近这个极限，但无法突破这个极限。
     因此，任务分解带来的性能收益是有一个度的，并不是任务分解越细越好。
     > 而对于架构设计来说，如何把握这个粒度就非常关键了。
     
     
### 第5章 复杂度来源-高可用
 * 高可用的定义：关键在于“无中断”
   + 硬件会出故障，软件会有 bug，硬件和软件本质上无法做到“无中断”
   + 外部环境：不可避免、不受控制，如：断电、水灾、地震
   
 * 系统的高可用本质
   + 通过“冗余”来实现高可用
   + 通过冗余增强了可用性，但同时也带来了复杂性
   
 1. 计算高可用
   + “计算”指的是业务的逻辑处理
   + 特点：就是无论在哪台机器上进行计算，同样的算法和输入数据，产出的结果都是一样的
   + 需要增加一个任务分配器
   + 任务分配器需要增加分配算法。如：双机算法有主备（细分：冷备，温备，热血），主主，1主多备，多主1备，多主多备，多主0备
 
 2. 存储高可用
   + 存储与计算相比，有一个本质上的区别：将数据从一台机器搬到到另一台机器，需要经过线路进行传输。
   这意味着整个系统在某个时间点上，数据肯定是不一致的，而数据的不一致又会导致业务问题。
   但如果完全不做冗余，系统的整体高可用又无法保证，所以存储高可用的难点不在于如何备份数据，而在于如何减少或者规避数据不一致对业务造成的影响。
     - 线路故障
     - 线程迟延，拥塞，丢包
   
 * 高可以状态决策
   + 系统需要能够判断当前的状态是正常还是异常，如果出现了异常就要采取行动来保证高可用
   
   + 决策方式
     1. 独裁独
       - 只有一个决策者，其它冗余都是上报者，上报者状态给决策者用来决策
       - 优点：决策方式简单不会出现混乱
       - 缺点：决策者故障，整个系统就无法实现正确决策
       
     2. 协商式
       - 两个独立个体通过交流信息，根据规则进行决策。主备常使用这种方式
       - 优点：架构简单，规则简单
       - 缺点：如果交换信息失败，导致决策不正确
       
     3. 民主式
       - 多个独立个体通过投票进行状态决策
       - 缺点：会发生脑裂
       - 解决脑裂：采用“投票节点数必须超过系统总节点数一半”规则来处理。但降低了可用性
         > 如：1，2，3，4，5台。1，2，3与4，5被脑裂隔离开，如果采用选举过办半数，1,2,3真的挂了，此时4,5选举也会失败，导致不可用
         
         
 * 综合分析：无论采取什么样的方案，状态决策都不可能做到任何场景下都没有问题，但完全不做高可用方案又会产生更大的问题，
 如何选取适合系统的高可用方案，也是一个复杂的分析、判断和选择的过程。
 
 
### 第6章 复杂度来源-可扩展性
 * 指系统为了应对将来需求变化而提供的一种扩展能力，当有新的需求出现时，系统不需要或者仅需要少量修改就可以支持，无须整个系统重构或者重建。
 * 设计具备良好可扩展性的系统，有两个基本条件：正确预测变化、完美封装变化。
 1. 预测变化
   + 预测变化的复杂性在于:
      - 不能每个设计点都考虑可扩展性，架构师会不堪重负
      - 不能完全不考虑可扩展性，否则可能系统刚上线，马上来新的需求就需要重构
      - 所有的预测都存在出错的可能性，甚至被明确否定，那么基于预测做的架构设计就没什么作用，投入的工作量也就白费了。
   + 对于架构师来说，如何把握预测的程度和提升预测结果的准确性，是一件很复杂的事情，而且没有通用标准
   
 2. 应对变化
   + 第一种：将“变化”封装在一个“变化层”，将不变的部分封装在一个独立的“稳定层”。
     - 无论是变化层依赖稳定层，还是稳定层依赖变化层都是可以的，需要根据具体业务情况来设计
     - 通过剥离变化层和稳定层的方式应对变化，都会带来两个主要的复杂性相关的问题。
     1. 系统需要拆分出变化层和稳定层
     2. 需要设计变化层和稳定层之间的接口
     
   + 第二种：提炼出一个“抽象层”和一个“实现层”
     - 抽象层是稳定的，实现层可以根据具体业务需要定制开发
     - 其实是设计模式和规则引擎的应用
     
### 第7章 复杂度来源-低成本，安全，规模
 * 低成本
   + 架构设计要考虑成本
   + 低成本给架构设计带来的主要复杂度体现在，往往只有“创新”才能达到低成本目标
   + 包括开创一个全新的技术领域（这个要求对绝大部分公司太高），也包括引入新技术
   
 * 安全
   + 功能安全
     - 常见的 XSS 攻击、CSRF 攻击、SQL 注入、Windows 漏洞、密码破解等
     - 从实现的角度来看，功能安全更多地是和具体的编码相关，与架构关系不大
   + 架构安全
     - 目前并没有太好的设计手段来实现，更多地是依靠运营商或者云服务商强大的带宽和流量清洗的能力，较少自己来设计和实现
   
 * 规模
   + 功能越来越多，导致系统复杂度指数级上升
   + 数据越来越多，系统复杂度发生质变
   > 解决：因此要做到在规模上升的时候不断演进架构，不断重构代码
   
   
   
### 第8章 架构设计原则
 * 合适原则、简单原则、演化原则
 * 合适原则
   + 合适当前业务
   + 合适当前团队
   + 合适当前成本
 * 简单原则
   + 注意结构的复杂性
   + 注意逻辑的复杂性
 * 演化原则
   + 首先，设计出来的架构要满足当时的业务需要
   + 其次，架构要不断地在实际应用过程中迭代，保留优秀的设计，修复有缺陷的设计，改正错误的设计，去掉无用的设计，使得架构逐渐完善。
   + 第三，当业务发生变化时，架构要扩展、重构，甚至重写；代码也许会重写，但有价值的经验、教训、逻辑、设计等（类似生物体内的基因）却可以在新架构中延续。
   
   
### 第10章 架构设计流程-复杂度识别
 * 将主要的复杂度问题列出来，然后根据业务、技术、团队等综合情况进行排序，优先解决当前面临的最主要的复杂度问题
 * 识别
   + 高性能：跟据请求量和预估峰值来识别
   + 高可用：业务是否要高可用
   + 可扩展：是否要支持扩展
   
### 第11章 架构设计流程-设计备选方案
 * 一般备选方案有3-5个
   + 可以防止思维狭隘，目光短浅，思维盲区等决策陷阱
   + 太少可能考虑不全
   + 太多设级东西太多，而且相似很多
   + 不用设计太细
   
 * 备选方案都要有明显的不同才行
 
 
### 第12章 架构设计流程-评估和选择备选方案
 * 没有哪个方案是完美的。例如，A 方案有性能的缺点，B 方案有成本的缺点，C 方案有新技术不成熟的风险。
 * 参与者
   + 研发
   + 测试
   + 运维
   + 几个业务主管
 * 360度评测维度
   + 性能
   + 实现复杂度
   + 硬件成本
   + 可运维性 
   + 可靠性
   + 人力投入
 * 架构师参与
   + 上线后的快速运维性
   + 目前团队技术实力与规模
   
### 第13章 架构设计流程-详细方案设计
 * 
  
